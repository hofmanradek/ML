------ CREATE SUMMARY TABLE FOR ALL ARRIVALS

select count(*) from idcx.arrival@idcdev where sta='URZ' and lddate > to_date('2018/07/24','yy/mm/dd'); --6459
select count(*) from idcx.arrival@extodb where sta='URZ' and lddate > to_date('2018/07/24','yy/mm/dd'); --5004
select count(*) from idcx.arrival@todb where sta='URZ' and lddate > to_date('2018/07/24','yy/mm/dd'); --4896


select count(*) from idcx.arrival@idcdev where sta='URZ' and lddate > to_date('2018/09/04','yy/mm/dd'); --2884
select min(lddate) from idcx.arrival@idcdev where sta='URZ' and lddate > to_date('2018/07/24','yy/mm/dd');



--- URZ weights to TST: 2018/09/25
select count(*) from idcx.arrival@todb where sta='URZ' and lddate >= to_date('2018/09/27','yy/mm/dd'); --3412 as of 20.11.


select min(lddate) from idcx.arrival@todb where sta='URZ';

drop table URZ_EVAL_TST;



CREATE TABLE URZ_EVAL_TST
AS (
--associated
SELECT ir.arid as arid_dev, er.arid as arid_odb, ir.time as time_dev, er.time as time_odb, ir.azimuth as azi_dev, er.azimuth as azi_odb, ir.iphase as iphase_dev, er.iphase as iphase_odb, ea.phase as assoc_phase
FROM idcx.arrival@todb ir, idcx.arrival@extodb er, leb.assoc@extodb ea
WHERE abs(ir.time-er.time) < 0.1
AND ir.sta='URZ' AND er.sta='URZ'
AND abs(ir.azimuth-er.azimuth) < 2  -- 2 degrees
AND ir.lddate >= to_date('2018/09/27','yy/mm/dd')
AND ea.arid=er.arid
  
UNION -- ALL
--not associated
SELECT ir.arid as arid_dev, er.arid as arid_odb, ir.time as time_dev, er.time as time_odb, ir.azimuth as azi_dev, er.azimuth as azi_odb, ir.iphase as iphase_dev, er.iphase as iphase_odb , null as assoc_phase
FROM idcx.arrival@todb ir, idcx.arrival@extodb er
WHERE abs(ir.time-er.time) < 0.1
AND ir.sta='URZ' AND er.sta='URZ'
AND abs(ir.azimuth-er.azimuth) < 2  -- 2 degrees
AND ir.lddate > to_date('2018/09/27','yy/mm/dd') --AND ir.lddate > to_date('2018/09/04','yy/mm/dd') and ir.lddate <= to_date('2018/09/27','yy/mm/dd')
AND er.arid not in (select arid from leb.assoc@extodb where sta='URZ' and lddate >= to_date('2018/09/27','yy/mm/dd'))

); -- 747 vs. 784 - some arrivals are missing, probably those retimed by analysts

commit;

select count(*) from URZ_EVAL_TST; --3251

ALTER TABLE URZ_EVAL_TST
  ADD (class_iphase_dev varchar2(5),
       class_iphase_odb varchar2(5),
       class_phase_odb  varchar2(5));


--numeric class identifiers for confidence matrix calculation purposes
ALTER TABLE URZ_EVAL_TST
  ADD (ncls_iphase_dev number,
       ncls_iphase_odb number,
       ncls_phase_odb  number);

commit;

select count(*) from URZ_EVAL_TST where abs(azi_dev - azi_odb) > 1;  -- 1

-- POPULATE CLASS COLUMNS
--
/*  from notebook
    """
    predicts initial wave type for given featrue vectors
    Class encoding generated by sklearn Label Encoder
    0 - noise
    2 - regS 
    1 - regP
    3 - T
    """
*/    
--    

UPDATE URZ_EVAL_TST SET CLASS_IPHASE_DEV = 'regS', ncls_iphase_dev=2  where IPHASE_DEV in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_TST SET CLASS_IPHASE_DEV = 'regP', ncls_iphase_dev=1  where IPHASE_DEV in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_TST SET CLASS_IPHASE_DEV = 'T',    ncls_iphase_dev=3  where IPHASE_DEV in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_TST SET CLASS_IPHASE_DEV = 'N',    ncls_iphase_dev=0  where IPHASE_DEV in ('N');

UPDATE URZ_EVAL_TST SET CLASS_IPHASE_ODB = 'regS', ncls_iphase_odb=2  where IPHASE_ODB in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_TST SET CLASS_IPHASE_ODB = 'regP', ncls_iphase_odb=1  where IPHASE_ODB in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_TST SET CLASS_IPHASE_ODB = 'T',    ncls_iphase_odb=3  where IPHASE_ODB in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_TST SET CLASS_IPHASE_ODB = 'N',    ncls_iphase_odb=0  where IPHASE_ODB in ('N');

UPDATE URZ_EVAL_TST SET CLASS_PHASE_ODB = 'regS', ncls_phase_odb=2  where assoc_phase in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_TST SET CLASS_PHASE_ODB = 'regP', ncls_phase_odb=1  where assoc_phase in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_TST SET CLASS_PHASE_ODB = 'T',    ncls_phase_odb=3  where assoc_phase in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_TST SET CLASS_PHASE_ODB = 'N',    ncls_phase_odb=0  where assoc_phase is null;

commit;

select * from URZ_EVAL_TST where class_iphase_dev is null or class_iphase_odb is null or class_phase_odb is null;

select count(*) from URZ_EVAL_TST;
select count(*) from URZ_EVAL_OCT;

select count(*) from URZ_EVAL_TST where assoc_phase is not null; -- 336 associated
 
select count(*) from URZ_EVAL_TST where class_iphase_dev='regS' and CLASS_PHASE_ODB='regS' and assoc_phase is not null; -- 51
select count(*) from URZ_EVAL_TST where class_iphase_odb='regS' and CLASS_PHASE_ODB='regS' and assoc_phase is not null; -- 30

select count(*) from URZ_EVAL_TST where class_iphase_dev='regP' and CLASS_PHASE_ODB='regP' and assoc_phase is not null; -- 46
select count(*) from URZ_EVAL_TST where class_iphase_odb='regP' and CLASS_PHASE_ODB='regP' and assoc_phase is not null; -- 44

select count(*) from URZ_EVAL_TST where class_iphase_dev='T' and CLASS_PHASE_ODB='T' and assoc_phase is not null; -- 132
select count(*) from URZ_EVAL_TST where class_iphase_odb='T' and CLASS_PHASE_ODB='T' and assoc_phase is not null; -- 112

select count(*) from URZ_EVAL_TST where class_iphase_dev = class_phase_odb; --1855/3251 correct => 0.57059
select count(*) from URZ_EVAL_TST where class_iphase_odb = class_phase_odb; --1656/3251 correct => 0.50938

select count(*) from URZ_EVAL_TST where class_iphase_dev = class_phase_odb and assoc_phase is not null; --229/336 cor => 0.6815476
select count(*) from URZ_EVAL_TST where class_iphase_odb = class_phase_odb and assoc_phase is not null; --186/336 cor => 0.5535714

select count(*) from URZ_EVAL_TST;

-- N phase rate
select count(*) from URZ_EVAL_TST where class_iphase_dev='N' and assoc_phase is not null; --13 / 336 0.03869047619047619
select count(*) from URZ_EVAL_TST where class_iphase_odb='N' and assoc_phase is not null; --57 / 336 0.16964285714285715

select count(*) from URZ_EVAL_TST where class_phase_odb not in ('regS', 'regP', 'T');  -- we have really just those associated
select count(*) from URZ_EVAL_TST where class_phase_odb not in ('regS', 'regP', 'T');  -- we have really just those associated

--------------------------------------- 






