-- new URZ weights deployed to OPS 10/12/2018
SET SERVEROUTPUT ON;

DECLARE
    total_num NUMBER DEFAULT 0;
    assoc_num NUMBER DEFAULT 0;
    assoc_num_S NUMBER DEFAULT 0;
    assoc_num_P NUMBER DEFAULT 0;
    assoc_num_T NUMBER DEFAULT 0;
    assoc_N_phase_num NUMBER DEFAULT 0;
    total_correct NUMBER DEFAULT 0;
    assoc_correct NUMBER DEFAULT 0;
    total_prec FLOAT;
    assoc_prec FLOAT;
PROCEDURE nn_stats(start_date DATE, end_date DATE, title VARCHAR2(20), station VARCHAR2(10))
AS
BEGIN
    /*
    EXECUTE IMMEDIATE 'DROP TABLE URZ_EVAL_OPS';
    CREATE TABLE URZ_EVAL_OPS
    AS (
        --associated
        SELECT er.arid as arid_odb, er.time as time_odb, er.azimuth as azi_odb, er.iphase as iphase_odb, ea.phase as assoc_phase
        FROM idcx.arrival@extadb er, leb.assoc@extadb ea
        WHERE er.sta='URZ'
            AND er.lddate >= to_date('2018/12/13','yy/mm/dd')
            AND ea.lddate >= to_date('2018/12/13','yy/mm/dd')
            AND ea.arid=er.arid
  
        UNION -- ALL
        --not associated
        SELECT er.arid as arid_odb, er.time as time_odb, er.azimuth as azi_odb, er.iphase as iphase_odb , null as assoc_phase
        FROM idcx.arrival@extadb er
        WHERE er.sta='URZ'
            AND er.lddate > to_date('2018/12/13','yy/mm/dd') 
            AND er.arid not in (select arid from leb.assoc@extadb where sta='URZ' and lddate >= to_date('2018/12/13','yy/mm/dd'))
        ); -- 747 vs. 784 - some arrivals are missing, probably those retimed by analysts

    commit;

    ALTER TABLE URZ_EVAL_OPS
    ADD (class_iphase_dev varchar2(5),
         class_iphase_odb varchar2(5),
         class_phase_odb  varchar2(5));


    --numeric class identifiers for confidence matrix calculation purposes
    ALTER TABLE URZ_EVAL_OPS
    ADD (ncls_iphase_dev number,
         ncls_iphase_odb number,
         ncls_phase_odb  number);

    commit;

    --select count(*) from URZ_EVAL_OPS where abs(azi_dev - azi_odb) > 1;  -- 0

    -- POPULATE CLASS COLUMNS
    --
    --  from notebook
    --    """
    --   predicts initial wave type for given featrue vectors
    --    Class encoding generated by sklearn Label Encoder
    --    0 - noise
    --    2 - regS 
    --    1 - regP
    --    3 - T
    --    """
        
    --    

    UPDATE URZ_EVAL_OPS SET CLASS_IPHASE_ODB = 'regS', ncls_iphase_odb=2  where IPHASE_ODB in ('Sn', 'Lg', 'Rg', 'Sx'); 
    UPDATE URZ_EVAL_OPS SET CLASS_IPHASE_ODB = 'regP', ncls_iphase_odb=1  where IPHASE_ODB in ('Pn', 'Pg', 'Px'); 
    UPDATE URZ_EVAL_OPS SET CLASS_IPHASE_ODB = 'T',    ncls_iphase_odb=3  where IPHASE_ODB in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
    UPDATE URZ_EVAL_OPS SET CLASS_IPHASE_ODB = 'N',    ncls_iphase_odb=0  where IPHASE_ODB in ('N');

    UPDATE URZ_EVAL_OPS SET CLASS_PHASE_ODB = 'regS', ncls_phase_odb=2  where assoc_phase in ('Sn', 'Lg', 'Rg', 'Sx'); 
    UPDATE URZ_EVAL_OPS SET CLASS_PHASE_ODB = 'regP', ncls_phase_odb=1  where assoc_phase in ('Pn', 'Pg', 'Px'); 
    UPDATE URZ_EVAL_OPS SET CLASS_PHASE_ODB = 'T',    ncls_phase_odb=3  where assoc_phase in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
    UPDATE URZ_EVAL_OPS SET CLASS_PHASE_ODB = 'N',    ncls_phase_odb=0  where assoc_phase is null;
    
    commit;
    */
    --select * from URZ_EVAL_OPS where class_iphase_odb is null or class_phase_odb is null;
    select count(*) INTO total_num  from URZ_EVAL_OPS; --25331
    select count(*) INTO assoc_num from URZ_EVAL_OPS where assoc_phase is not null; -- 3525 associated
    select count(*) INTO assoc_num_S from URZ_EVAL_OPS where class_iphase_odb='regS' and CLASS_PHASE_ODB='regS' and assoc_phase is not null; -- 786  
    select count(*) INTO assoc_num_P from URZ_EVAL_OPS where class_iphase_odb='regP' and CLASS_PHASE_ODB='regP' and assoc_phase is not null; 
    select count(*) INTO assoc_num_T from URZ_EVAL_OPS where class_iphase_odb='T' and CLASS_PHASE_ODB='T' and assoc_phase is not null; -- 853
    select count(*) INTO total_correct from URZ_EVAL_OPS where class_iphase_odb = class_phase_odb; -- 14552/25331 correct => 57.447396470727563
    select count(*) INTO assoc_correct from URZ_EVAL_OPS where class_iphase_odb = class_phase_odb and assoc_phase is not null; -- 2246/3525 cor => 63.71%
    
    -- N phase rate
    select count(*) INTO assoc_N_phase_num from URZ_EVAL_OPS where class_iphase_odb='N' and assoc_phase is not null; -- 314/3525 8.9%

    DBMS_OUTPUT.PUT_LINE('----------------------------------------------------');
    DBMS_OUTPUT.PUT_LINE(title);
    DBMS_OUTPUT.PUT_LINE('----------------------------------------------------');
    DBMS_OUTPUT.PUT_LINE('Total phases          '||total_num);    
    DBMS_OUTPUT.PUT_LINE('Total associated      '||assoc_num);    
    DBMS_OUTPUT.PUT_LINE('  + regS              '||assoc_num_S);
    DBMS_OUTPUT.PUT_LINE('  + regP              '||assoc_num_P);
    DBMS_OUTPUT.PUT_LINE('  + T                 '||assoc_num_T);
    DBMS_OUTPUT.PUT_LINE('----------------------------------------------------');
    DBMS_OUTPUT.PUT_LINE('Accuracy all          '||round(total_correct/total_num*100, 2)||'%');    
    DBMS_OUTPUT.PUT_LINE('Accuracy associated   '||round(assoc_correct/assoc_num*100, 2)||'%');    
    DBMS_OUTPUT.PUT_LINE('N phase rate          '||round(assoc_N_phase_num/assoc_num*100, 2)||'%');    
    DBMS_OUTPUT.PUT_LINE('----------------------------------------------------');

END;
/


BEGIN
    nn_stats(DATE '2018-03-13', DATE '2018-12-13');
END;
--------------------------------------- 
--
--
--
--
--BEFORE THE UPDATE
--
--
--
--
---------------------------------------
/*
drop table URZ_EVAL_OPS_OLDW;

CREATE TABLE URZ_EVAL_OPS_OLDW
AS (
--associated
SELECT er.arid as arid_odb, er.time as time_odb, er.azimuth as azi_odb, er.iphase as iphase_odb, ea.phase as assoc_phase
FROM idcx.arrival@extadb er, leb.assoc@extadb ea
WHERE er.sta='URZ'
AND er.lddate >= to_date('2018/03/13','yy/mm/dd') and er.lddate < to_date('2018/12/13','yy/mm/dd')
AND ea.lddate >= to_date('2018/03/13','yy/mm/dd') and ea.lddate < to_date('2018/12/13','yy/mm/dd')
AND ea.arid=er.arid
  
UNION -- ALL
--not associated
SELECT er.arid as arid_odb, er.time as time_odb, er.azimuth as azi_odb, er.iphase as iphase_odb , null as assoc_phase
FROM idcx.arrival@extadb er
WHERE er.sta='URZ'
AND er.lddate >= to_date('2018/03/13','yy/mm/dd') and er.lddate < to_date('2018/12/13','yy/mm/dd')
AND er.arid not in (select arid from leb.assoc@extadb where sta='URZ' and lddate >= to_date('2018/03/13','yy/mm/dd') and lddate < to_date('2018/12/13','yy/mm/dd'))
); -- 747 vs. 784 - some arrivals are missing, probably those retimed by analysts

commit;

select count(*) from URZ_EVAL_OPS_OLDW; --22006

ALTER TABLE URZ_EVAL_OPS_OLDW
  ADD (class_iphase_dev varchar2(5),
       class_iphase_odb varchar2(5),
       class_phase_odb  varchar2(5));


--numeric class identifiers for confidence matrix calculation purposes
ALTER TABLE URZ_EVAL_OPS_OLDW
  ADD (ncls_iphase_dev number,
       ncls_iphase_odb number,
       ncls_phase_odb  number);

commit;


-- POPULATE CLASS COLUMNS
--
--  from notebook
--    """
--    predicts initial wave type for given featrue vectors
--    Class encoding generated by sklearn Label Encoder
--    0 - noise
--    2 - regS 
--    1 - regP
--    3 - T
--    """ 
--    


UPDATE URZ_EVAL_OPS_OLDW SET CLASS_IPHASE_ODB = 'regS', ncls_iphase_odb=2  where IPHASE_ODB in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_OPS_OLDW SET CLASS_IPHASE_ODB = 'regP', ncls_iphase_odb=1  where IPHASE_ODB in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_OPS_OLDW SET CLASS_IPHASE_ODB = 'T',    ncls_iphase_odb=3  where IPHASE_ODB in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_OPS_OLDW SET CLASS_IPHASE_ODB = 'N',    ncls_iphase_odb=0  where IPHASE_ODB in ('N');

UPDATE URZ_EVAL_OPS_OLDW SET CLASS_PHASE_ODB = 'regS', ncls_phase_odb=2  where assoc_phase in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_OPS_OLDW SET CLASS_PHASE_ODB = 'regP', ncls_phase_odb=1  where assoc_phase in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_OPS_OLDW SET CLASS_PHASE_ODB = 'T',    ncls_phase_odb=3  where assoc_phase in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_OPS_OLDW SET CLASS_PHASE_ODB = 'N',    ncls_phase_odb=0  where assoc_phase is null;

commit;

select * from URZ_EVAL_OPS_OLDW where class_iphase_odb is null or class_phase_odb is null;  --T ????

select count(*) from URZ_EVAL_OPS_OLDW; --22006

select count(*) from URZ_EVAL_OPS_OLDW where assoc_phase is not null; -- 2552 associated
 

select count(*) from URZ_EVAL_OPS_OLDW where class_iphase_odb='regS' and CLASS_PHASE_ODB='regS' and assoc_phase is not null; -- 219


select count(*) from URZ_EVAL_OPS_OLDW where class_iphase_odb='regP' and CLASS_PHASE_ODB='regP' and assoc_phase is not null; -- 338


select count(*) from URZ_EVAL_OPS_OLDW where class_iphase_odb='T' and CLASS_PHASE_ODB='T' and assoc_phase is not null; -- 749


select count(*) from URZ_EVAL_OPS_OLDW where class_iphase_odb = class_phase_odb; -- 10951/22006 correct => 49.76


select count(*) from URZ_EVAL_OPS_OLDW where class_iphase_odb = class_phase_odb and assoc_phase is not null; -- 1306/2552 cor => 51.17%

select count(*) from URZ_EVAL_OPS_OLDW;

-- N phase rate

select count(*) from URZ_EVAL_OPS_OLDW where class_iphase_odb='N' and assoc_phase is not null; -- 496/2552 19.43%

select count(*) from URZ_EVAL_OPS_OLDW where class_phase_odb not in ('regS', 'regP', 'T');  -- we have really just those associated

*/



