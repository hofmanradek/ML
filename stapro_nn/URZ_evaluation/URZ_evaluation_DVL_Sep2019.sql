------ CREATE SUMMARY TABLE FOR ALL ARRIVALS

-- new URZ weights deployed to OPS 10/12/2018
-- to this date the NN weights are the same for DVL and OPS

select count(*) from idcx.arrival@idcdev where sta='URZ' and lddate > to_date('2018/12/13','yy/mm/dd');--23884
select count(*) from idcx.arrival@extadb where sta='URZ' and lddate > to_date('2018/12/13','yy/mm/dd');--25327
select count(*) from idcx.arrival@tadb where sta='URZ' and lddate > to_date('2018/12/13','yy/mm/dd');--26306



select count(*) from idcx.arrival@idcdev where sta='URZ' and time >= 1544659200;--23869
select count(*) from idcx.arrival@extadb where sta='URZ' and time >= 1544659200;--25324

----------------------------
SELECT count(*) FROM idcx.arrival@idcdev ir, idcx.arrival@extadb er
WHERE abs(ir.time-er.time) < 0.1
AND abs(ir.azimuth-er.azimuth) < 2
AND ir.sta='URZ' AND er.sta='URZ'
AND ir.lddate >= to_date('2018/12/13','yy/mm/dd')
AND er.lddate >= to_date('2018/12/13','yy/mm/dd'); --15094
----------------------------

----------------------------
SELECT count(*) FROM idcx.arrival@idcdev ir, idcx.arrival@extadb er
WHERE abs(ir.time-er.time) < 0.1
AND abs(ir.azimuth-er.azimuth) < 2
AND ir.sta='URZ' AND er.sta='URZ'
AND ir.time >= 1544659200
AND er.time >= 1544659200; --15091
----------------------------




drop table URZ_EVAL_DVL_SEP2019;



CREATE TABLE URZ_EVAL_DVL_SEP2019
AS (
--associated
SELECT ir.arid as arid_dev, er.arid as arid_odb, ir.time as time_dev, er.time as time_odb, ir.azimuth as azi_dev, er.azimuth as azi_odb, ir.iphase as iphase_dev, er.iphase as iphase_odb, ea.phase as assoc_phase
FROM idcx.arrival@idcdev ir, idcx.arrival@extadb er, leb.assoc@extadb ea
WHERE abs(ir.time-er.time) < 0.1
AND ir.sta='URZ' AND er.sta='URZ'
AND abs(ir.azimuth-er.azimuth) < 2  -- 2 degrees
AND ir.lddate >= to_date('2018/12/13','yy/mm/dd')
AND er.lddate >= to_date('2018/12/13','yy/mm/dd')
AND ea.lddate >= to_date('2018/12/13','yy/mm/dd')
AND ea.arid=er.arid
  
UNION ALL
--not associated
SELECT ir.arid as arid_dev, er.arid as arid_odb, ir.time as time_dev, er.time as time_odb, ir.azimuth as azi_dev, er.azimuth as azi_odb, ir.iphase as iphase_dev, er.iphase as iphase_odb , null as assoc_phase
FROM idcx.arrival@idcdev ir, idcx.arrival@extadb er
WHERE abs(ir.time-er.time) < 0.1
AND ir.sta='URZ' AND er.sta='URZ'
AND abs(ir.azimuth-er.azimuth) < 2  -- 2 degrees
AND ir.lddate >= to_date('2018/12/13','yy/mm/dd') --AND ir.lddate > to_date('2018/09/04','yy/mm/dd') and ir.lddate <= to_date('2018/09/27','yy/mm/dd')
AND er.lddate >= to_date('2018/12/13','yy/mm/dd')
AND er.arid not in (select arid from leb.assoc@extadb where sta='URZ' and lddate >= to_date('2018/12/13','yy/mm/dd'))

);

commit;

ALTER TABLE URZ_EVAL_DVL_SEP2019
  ADD (class_iphase_dev varchar2(5),
       class_iphase_odb varchar2(5),
       class_phase_odb  varchar2(5));


--numeric class identifiers for confidence matrix calculation purposes
ALTER TABLE URZ_EVAL_DVL_SEP2019
  ADD (ncls_iphase_dev number,
       ncls_iphase_odb number,
       ncls_phase_odb  number);

commit;

select count(*) from URZ_EVAL_DVL_SEP2019 where abs(azi_dev - azi_odb) > 2;

-- POPULATE CLASS COLUMNS
--
/*  from notebook
    """
    predicts initial wave type for given featrue vectors
    Class encoding generated by sklearn Label Encoder
    0 - noise
    2 - regS 
    1 - regP
    3 - T
    """
*/    
--    

UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_DEV = 'regS', ncls_iphase_dev=2  where IPHASE_DEV in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_DEV = 'regP', ncls_iphase_dev=1  where IPHASE_DEV in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_DEV = 'T',    ncls_iphase_dev=3  where IPHASE_DEV in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_DEV = 'N',    ncls_iphase_dev=0  where IPHASE_DEV in ('N');

UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_ODB = 'regS', ncls_iphase_odb=2  where IPHASE_ODB in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_ODB = 'regP', ncls_iphase_odb=1  where IPHASE_ODB in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_ODB = 'T',    ncls_iphase_odb=3  where IPHASE_ODB in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_IPHASE_ODB = 'N',    ncls_iphase_odb=0  where IPHASE_ODB in ('N');

UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_PHASE_ODB = 'regS', ncls_phase_odb=2  where assoc_phase in ('Sn', 'Lg', 'Rg', 'Sx'); 
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_PHASE_ODB = 'regP', ncls_phase_odb=1  where assoc_phase in ('Pn', 'Pg', 'Px'); 
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_PHASE_ODB = 'T',    ncls_phase_odb=3  where assoc_phase in ('P', 'PKP', 'PKPbc', 'PcP', 'PKPab', 'pP', 'PP', 'PKKPbc', 'ScP', 'SKPbc', 'PKhKP', 'PKiKP', 'PKP2', 'Pdiff', 'SKP', 'pPKP', 'PKKPab', 'pPKPbc', 'PKKP', 'SKKPbc', 'PKP2bc', 'P3KPbc', 'sP', 'SKPab', 'P4KPbc', 'PKP2ab', 'pPKPab', 'P3KP', 'SKKP', 'SKiKP', 'SKKPab', 'SKKS', 'P4KP', 'SP', 'S', 'ScS', 'SS', 'Sdiff', 'pPcP', 'sPKP', 'tx');
UPDATE URZ_EVAL_DVL_SEP2019 SET CLASS_PHASE_ODB = 'N',    ncls_phase_odb=0  where assoc_phase is null;

commit;

select * from URZ_EVAL_DVL_SEP2019 where class_iphase_dev is null or class_iphase_odb is null or class_phase_odb is null;

select count(*) from URZ_EVAL_DVL_SEP2019; --15094


select count(*) from URZ_EVAL_DVL_SEP2019 where assoc_phase is not null; -- associated phases 2260
 
select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_dev='regS' and CLASS_PHASE_ODB='regS' and assoc_phase is not null; -- 491
select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_odb='regS' and CLASS_PHASE_ODB='regS' and assoc_phase is not null; -- 490

select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_dev='regP' and CLASS_PHASE_ODB='regP' and assoc_phase is not null; -- 357
select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_odb='regP' and CLASS_PHASE_ODB='regP' and assoc_phase is not null; -- 357

select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_dev='T' and CLASS_PHASE_ODB='T' and assoc_phase is not null; -- 604
select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_odb='T' and CLASS_PHASE_ODB='T' and assoc_phase is not null; -- 604

select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_dev = class_phase_odb; -- 8678/15094 correct=> 57.49%
select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_odb = class_phase_odb; -- 8671/15094 correct=> 57.44%

select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_dev = class_phase_odb and assoc_phase is not null; --  1452/2260 => 64.24%
select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_odb = class_phase_odb and assoc_phase is not null; --  1451/2260 => 64.24%

select count(*) from URZ_EVAL_DVL_SEP2019; --15094

select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_dev='N' and assoc_phase is not null; -- 185/2260 => 8.18%
select count(*) from URZ_EVAL_DVL_SEP2019 where class_iphase_odb='N' and assoc_phase is not null; -- 186/2260 => 8.18% 

select count(*) from URZ_EVAL_DVL_SEP2019 where class_phase_odb not in ('regS', 'regP', 'T');  -- we have really just those associated 12834 + 2260 = 15094

--------------------------------------- 





